output_dir: ./results # Will be set at runtime or can run with --output_dir

data_config:
  train:
    batch_size: 4 # Testing maximum batch size on A100 40GB
    dataloader_num_workers: 4
    dataset:
      target: HYPIR.dataset.paired.PairedParquetDataset
      params:
        file_meta:
          file_list: custom_5k_imp.parquet # Will be set by user or script
          lq_key: lq_path
          gt_key: gt_path
          prompt_key: prompt
        out_size: 512
        crop_type: none # Assuming provided images are already cropped or resized
        use_hflip: true
        use_rot: true
        return_file_name: false

    batch_transform:
      target: HYPIR.dataset.batch_transform.IdentityBatchTransform
      params:
        hq_key: GT
        extra_keys: [LQ, txt]

  val:
    val_dir: /data/users/gaoyin/datasets/AIO/Val
    degradation_types: [Blur, Haze, Lowlight, Rain, Snow]
    batch_size: 1
    num_samples_per_type: ~  # None表示验证全部图片（每类约100张）

base_model_type: sd2
base_model_path: stabilityai/stable-diffusion-2-1-base
model_t: 200
coeff_t: 200
lora_rank: 256
lora_modules: [to_k, to_q, to_v, to_out.0, conv, conv1, conv2, conv_shortcut, conv_out, proj_in, proj_out, ff.net.2, ff.net.0.proj]
use_ema: true
ema_decay: 0.999
resume_ema: true

# 改进策略1: 调整损失权重，增强像素级监督
lambda_gan: 0.3        # 降低GAN损失权重（从0.5降到0.3），减少过度平滑
lambda_lpips: 3.0      # 降低LPIPS权重（从5降到3），平衡感知质量和像素精度
lambda_l2: 2.0         # 增加L2损失权重（从1增到2），提高PSNR
lambda_l1: 2.0         # 增加L1损失权重（从1增到2），增强像素级精度
lambda_ssim: 1.0       # 新增SSIM损失，直接优化SSIM指标

# 改进策略2: 调整学习率
lr_G: 2e-5             # 提高生成器学习率（从1e-5到2e-5），加快收敛
lr_D: 5e-6             # 降低判别器学习率（从1e-5到5e-6），避免判别器过强

optimizer_type: adam
opt_kwargs:
  betas: [0.9, 0.999]
  weight_decay: 1e-4   # 添加权重衰减，防止过拟合

mixed_precision: bf16 # Use bf16 for speed and memory saving on Ampere+ GPUs
seed: 231
max_train_steps: 50000 # Adjusted for 5k dataset
gradient_accumulation_steps: 1
gradient_checkpointing: true
max_grad_norm: 1.0
logging_dir: logs
report_to: swanlab
swanlab_project: HYPIR
checkpointing_steps: 500
checkpoints_total_limit: 2
resume_from_checkpoint: ~ # Can be set to resume training
log_image_steps: 100
log_grad_steps: 100
log_grad_modules: [conv_out]
validation_steps: 500  # 每500步验证一次
